apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: immich
  namespace: kube-system
spec:
  repo: oci://ghcr.io/immich-app/immich-charts
  chart: immich
  targetNamespace: immich
  createNamespace: true
  valuesContent: |-
    # Shared configuration for all Immich components
    controllers:
      main:
        containers:
          main:
            image:
              tag: v2.5.2
            env:
              REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
              IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
              DB_HOSTNAME: immich-database-rw
              DB_DATABASE_NAME: immich
              DB_USERNAME: immich
              DB_PASSWORD: immich_secret_password_change_me
              TZ: America/Los_Angeles

    # Immich configuration
    immich:
      metrics:
        enabled: false
      persistence:
        library:
          existingClaim: immich-library-pvc
      configuration: {}
      configurationKind: ConfigMap

    # Valkey (Redis) - built-in from chart
    valkey:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: docker.io/valkey/valkey
                tag: 8-alpine
      persistence:
        data:
          enabled: true
          size: 5Gi
          type: persistentVolumeClaim
          accessMode: ReadWriteOnce
          storageClass: longhorn

    # Immich server
    server:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: ghcr.io/immich-app/immich-server
                pullPolicy: IfNotPresent
      service:
        main:
          type: ClusterIP
          ports:
            http:
              port: 2283

    # Machine learning component
    machine-learning:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: ghcr.io/immich-app/immich-machine-learning
                pullPolicy: IfNotPresent
              env:
                TRANSFORMERS_CACHE: /cache
                HF_XET_CACHE: /cache/huggingface-xet
                MPLCONFIGDIR: /cache/matplotlib-config
      persistence:
        cache:
          enabled: true
          size: 10Gi
          type: persistentVolumeClaim
          accessMode: ReadWriteOnce
          storageClass: longhorn
